<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="./resources/potree.css">
</head>
<body style="padding: 0; margin: 0">

<div id="potree" style="width: 100%; height: 100%; position: fixed;">
	<span style="position: relative">
		<canvas id="canvas" width="800" height="600" style="width: 100%; height: 100%;"></canvas>
		<!-- <input id="btn_toggle" type="button" value="toggle" style="position: absolute; left: 10px; top: 10px"></input> -->
	</span>
</div>

<span id="big_message"></span>
<pre id="msg_dbg"></pre>
<pre id="msg_resources"></pre>

<script type="importmap">
{
	"imports": {
		"potree":        "./src/Potree.js",
		"lazperf":       "./libs/laz-perf/laz-perf.js",
		"toolbar":       "./src/modules/toolbar/toolbar.js",
		"sidebar":       "./src/modules/sidebar/sidebar.js",
		"dat.gui":       "./libs/dat.gui/dat.gui.module.js",
		"stats":         "./libs/stats.js/stats.module.js",
		"BinaryHeap":    "./libs/BinaryHeap/BinaryHeap.js",
		"tween":         "./libs/tween/tween.esm.js",
		"range-select":  "./libs/range-select/RangeSelect.js",
		"json5":         "./libs/json5/json5.js",
		"proj4":         "./libs/proj4js/proj4-src.js"
	}
}
</script>

<script type="module">

	import {Potree} from "potree";
	import {Vector3, Mesh, Geometry, geometries, Points, PointLight} from "potree";
	import {WireframeMaterial, TriangleColorMaterial} from "potree";
	import {initGUI} from "./src/modules/gui_dat/gui.js";
	import "range-select";
	import {proj4} from "./libs/proj4js/proj4-src.js";
	import {load as loadGLB} from "./src/misc/GLBLoader.js";
	// import {GlbVoxelLoader} from "./src/misc/glbvoxels/GlbVoxelLoader.js";

	console.log(proj4.version);

	import {installToolbar} from "toolbar";
	import {installSidebar} from "sidebar";

	let canvas = document.getElementById("canvas");
	let elPotree = document.getElementById("potree");
	let potree = await Potree.init(canvas);
	let {scene, controls} = potree;
	

	
	installSidebar(elPotree, potree).then(sidebar => {
		window.sidebar = sidebar;
		let panelAttributes = sidebar.sections.find(section => section.handler.name === "Attributes").handler;
		let pointcloud = scene.root.children.find(c => c.constructor.name === "PointCloudOctree");
		
		if(panelAttributes && pointcloud){
			panelAttributes.set(pointcloud);
		}
	});
	installToolbar(elPotree, potree);
	// window.sidebar.toggle();

	window.Potree = Potree;
	window.potree = potree;
	window.Vector3 = Vector3;

	// default, if not overriden later on
	// controls.set({
	// 	position: [-19.0, 13.6, 12.2],
	// 	pivot: [-0.0, 2.2, 3.9],
	// });

	import {CopcLoader, Image360, Images360, SplatType} from "potree";
	import {PotreeLoader, Potree3Loader} from "potree";
	import {MAPPINGS} from "./src/modules/attributes/mappings.js";
	import {PointMeasure, DistanceMeasure, HeightMeasure} from "potree";

	Potree.settings.edlEnabled      = true;
	Potree.settings.dilateEnabled   = false;
	// Potree.settings.hqsEnabled      = true;
	// Potree.settings.sampleCount     = 1;
	Potree.settings.pointBudget     = 8_000_000;
	Potree.settings.attribute       = "rgba";
	// Potree.settings.attribute = "intensity";
	Potree.settings.splatType       = SplatType.QUADS;
	// Potree.settings.splatType       = SplatType.POINTS;
	Potree.settings.pointSize       = 2;
	Potree.settings.minNodeSize     = 50;
	Potree.settings.showBoundingBox = false;


	// let measure = new PointMeasure();
	// measure.markers.push(new Vector3(50, -250, 12));
	// potree.measure.measures.push(measure);

	// let md = new DistanceMeasure();
	// md.markers.push(new Vector3(-160.293,  133.898,  38.785));
	// md.markers.push(new Vector3(-162.407, -166.239,  60.978));
	// md.markers.push(new Vector3(  35.218,   96.909,  16.592));
	// md.markers.push(new Vector3( 119.764, -141.932, -37.834));
	// md.markers.push(new Vector3( 233.900, -301.512, -25.681));
	// md.markers.push(new Vector3( 338.525, -152.500, -36.777));
	// md.markers.push(new Vector3( 239.184,   13.420, -20.925));
	// potree.measure.measures.push(md);

	// let mh = new HeightMeasure();
	// mh.markers.push(new Vector3(154.639, 122.273,  56.751));
	// mh.markers.push(new Vector3( 17.252, -70.069, -48.931));
	// potree.measure.measures.push(mh);


	Potree.events.onFrameStart(() => {
		let report = Potree.renderer.createResourceReport();

		document.getElementById("msg_resources").innerText = report;
	});

	Potree3Loader.load("./resources/pointclouds/eclepens.potree").then(pointcloud => {
		console.log(pointcloud);

		scene.root.children.push(pointcloud);

		// pointcloud.position.set(2547035.6, 1212135.1, 1022.5);
		pointcloud.name = "Heidentor";

		let material = pointcloud.material;

		controls.zoomTo(pointcloud);

		

		controls.set({
			position: [245.1, -536.2, 343.5], 
			pivot:    [144.2, -23.0, -87.8]
		});
	});

	

	// Potree3Loader.load("./resources/pointclouds/CA16_SolanaBeach.potree").then(pointcloud => {
	// 	console.log(pointcloud);

	// 	scene.root.children.push(pointcloud);

	// 	// pointcloud.position.set(2547035.6, 1212135.1, 1022.5);
	// 	pointcloud.name = "New Format";

	// 	let material = pointcloud.material;

	// 	controls.zoomTo(pointcloud);

		

	// 	controls.set({
	// 		position: [6247542.9, 1941183.6, 94.9],
	// 		pivot:    [6247696.5, 1941394.7, -29.2]
	// 	});
	// });

	// PotreeLoader.load("./resources/pointclouds/CA16_SolanaBeach/metadata.json").then(pointcloud => {
	// 	console.log(pointcloud);

	// 	scene.root.children.push(pointcloud);

	// 	// pointcloud.position.set(2547035.6, 1212135.1, 1022.5);
	// 	pointcloud.name = "Old Format";

	// 	let material = pointcloud.material;

	// 	// controls.zoomTo(pointcloud);

	// 	controls.set({
	// 		position: [6247542.9, 1941183.6, 94.9], 
	// 		pivot:    [6247696.5, 1941394.7, -29.2]
	// 	});

	// });

	// PotreeLoader.load("https://sitn.ne.ch/lidar/pointclouds/aerial/2022/lidar2022/metadata.json").then(pointcloud => {
	// 	console.log(pointcloud);

	// 	scene.root.children.push(pointcloud);

	// 	// pointcloud.position.set(2547035.6, 1212135.1, 1022.5);
	// 	pointcloud.name = "SITN 2022";

	// 	let material = pointcloud.material;

	// 	controls.set({
	// 		position: [2552249.3, 1197175.4, 554.1],
	// 		pivot:    [2552120.0, 1197638.8, 204.9]
	// 	});
	// 	controls.set({
	// 		position: [2558301.3, 1184586.7, 17112.5], 
	// 		pivot:    [2552120.0, 1197638.8, 204.9]
	// 	});

	// 	// [2547035.6, 1212135.1, 1022.5], 
	// 	// [2547043.3, 1212154.7, 1000.0]
	// });
	


</script>

</body>
</html>