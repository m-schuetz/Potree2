<html>
<head>
<style>

td{
	padding: 2px 10px 0px 0px;
}

#big_message{
	position: absolute; 
	left: calc(50%); 
	bottom: 10px; 
	color: white;
	text-shadow: 4px 4px 4px black;
	font-size: 4em;
	font-weight: bold;
	font-family: "Consolas";
	/* from https://stackoverflow.com/a/14249403/913630 */
	text-shadow: 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black;
}

#msg_dbg{
	position: absolute; 
	left: 10px; 
	bottom: 10px; 
	color: white;
	text-shadow: 4px 4px 4px black;
	font-size: 1em;
	font-weight: bold;
	font-family: "Consolas";
	/* from https://stackoverflow.com/a/14249403/913630 */
	text-shadow: 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black;
}

canvas{
	image-rendering: pixelated;
}

</style>
</head>
<body style="padding: 0; margin: 0">


<canvas id="canvas" width="800" height="600" 
	style="
		width: 100%; height: 100%;
		grid-column: 1; grid-row: 1">
</canvas>

<!-- <span style="position: absolute; left: 10px; top: 70px; 
	background-color: white; opacity: 0.7; padding: 10px;">
	
	<span style="font-weight: bold">Rewriting Potree in WebGPU:</span>

	<ul>
		<li>Highly experimental and crashy.</li>
		<li>Requires <a href="https://www.google.com/intl/de/chrome/canary/">Chrome Canary 92</a></li>
		<li>To enable WebGPU, open this URL: <pre>chrome://flags/#enable-unsafe-webgpu</pre></li>
		<li>Github: <a href="https://github.com/m-schuetz/Potree2">https://github.com/m-schuetz/Potree2</a></li>
	</ul>

</span> -->

<span id="big_message"></span>
<span id="msg_dbg"></span>

<script type="importmap">
{
	"imports": {
		"potree":      "./src/Potree.js",
		"toolbar":     "./src/modules/toolbar/toolbar.js",
		"dat.gui":     "./libs/dat.gui/dat.gui.module.js",
		"glslang":     "./libs/glslang/glslang.js",
		"stats":       "./libs/stats.js/stats.module.js",
		"BinaryHeap":  "./libs/BinaryHeap/BinaryHeap.js"
	}
}
</script>

<script type="module">

	import {Potree} from "potree";
	import {Vector3, Mesh, Geometry, Quads, geometries, Points, PointLight} from "potree";
	import {WireframeMaterial, TriangleColorMaterial} from "potree";
	import {initGUI} from "./src/modules/gui_dat/gui.js";
	import {loadGLB} from "./src/prototyping/glbloader/loadGLB.js";
	import {GlbVoxelLoader} from "./src/misc/glbvoxels/GlbVoxelLoader.js";

	import {installToolbar} from "toolbar";

	let canvas = document.getElementById("canvas");
	let potree = await Potree.init(canvas);
	let {scene, controls} = potree;
	installToolbar(potree.renderer.canvas, potree);

	window.Potree = Potree;
	window.potree = potree;
	window.Vector3 = Vector3;

	initGUI(potree);
	guiContent["point budget (M)"] = 2;
	guiContent["point size"] = 5;
	guiContent["High-Quality"] = false;
	guiContent["Eye-Dome-Lighting"] = true;
	guiContent["dilate"] = false;
	// guiContent["attribute"] = "intensity";




	// default, if not overriden later on
	controls.set({
		yaw: -0.2,
		pitch: 0.8,
		radius: 10,
	});

	controls.set({
		position: [-0.8, 0.7, -4.5],
		pivot: [0.7, 0.3, -6.4],
	});

	// SITN
	controls.set({
		position: [2290.5, 1352.2, 957.3],
		pivot: [2361.6, 1362.4, 916.1],
	});
	

	{
		let light = new PointLight();
		light.position.set(10, 10, 10);

		scene.root.children.push(light);

		// controls.set({
		// 	position: [2334.5, 1408.7, 954.4],
		// 	pivot: [2335.0, 1377.2, 910.0],
		// });
	}

	// let url = "./resources/pointclouds/heidentor/metadata.json";
	// Potree.load(url, {name: "Heidentor"}).then(pointcloud => {
	// 	scene.root.children.push(pointcloud);

	// 	controls.set({
	// 		radius: 26.8, yaw: -4.2, pitch: 0.31,
	// 		pivot: [-0.182792265881022, 1.9724050351418307, 5.693598313985278],
	// 	});
	// });

	potree.onUpdate( () => {
		potree.renderer.drawLine(
			new Vector3(0, 0, 0),
			new Vector3(10, 0, 0),
			new Vector3(255, 0, 0),
		);
		potree.renderer.drawLine(
			new Vector3(0, 0, 0),
			new Vector3(0, 10, 0),
			new Vector3(0, 255, 0),
		);
		potree.renderer.drawLine(
			new Vector3(0, 0, 0),
			new Vector3(0, 0, 10),
			new Vector3(0, 0, 255),
		);
	});

	// GlbVoxelLoader.load("./resources/models/lion.glb", () => {
	// // GlbVoxelLoader.load("./resources/models/Big5M.glb", () => {
		
	// });

	import {Potree3Loader} from "./src/misc/potree3loader/Potree3Loader.js";
	Potree3Loader.load("./temp").then(() => {
		console.log("abc");
	});

	import {SPECTRAL, PhongMaterial} from "potree";

	if(false)
	{

		let rMetadata = await fetch(`./temp/metadata.json`);
		let jsMetadata = await rMetadata.json();

		let items = [];

		for(let nodeName of jsMetadata.nodes){
			let basename = `./temp/${nodeName}_voxels`;

			items.push(basename);

			break;
		}


		let i = 0;
		for(let item of items){

			let rPositions = await fetch(`${item}_positions.bin`);
			let rColors = await fetch(`${item}_colors.bin`);

			let bPositions = await rPositions.arrayBuffer();
			let bColors = await rColors.arrayBuffer();

			let positions = new Float32Array(bPositions);
			let colors = new Uint8Array(bColors);

			// potree.onUpdate(() => {

			// 	let level = item.length - 14;
			// 	// let voxelSize = (1 / 8) / Math.pow(2, level);
			// 	// let voxelSize = 0.05;
			// 	let voxelSize = 5.539963245391846 / jsMetadata.gridSize;
			// 	potree.renderer.drawVoxels(positions, colors, voxelSize);
				
			// 	let numVoxels = positions.length / 3;
			// });

		}
	}

	if(false)
	{
		let url = "./temp";

		let items = [
			// `./temp/r073_mesh`,
			`./temp/r125_mesh`,
		];

		let i = 0;
		for(let item of items){

			let rPositions = await fetch(`${item}_positions.bin`);
			let rUVs = await fetch(`${item}_uvs.bin`);

			let bPositions = await rPositions.arrayBuffer();
			let bUVs = await rUVs.arrayBuffer();

			let positions = new Float32Array(bPositions);
			let uvs = new Float32Array(bUVs);

			let numVertices = positions.length / 3;
			let colors_u8 = new Uint8Array(4 * numVertices);

			let color = SPECTRAL.get(10 * i / items.length);

			for(let j = 0; j < numVertices; j++){
				colors_u8[4 * j + 0] = color[0],
				colors_u8[4 * j + 1] = color[1],
				colors_u8[4 * j + 2] = color[2],
				colors_u8[4 * j + 3] = 255;

				uvs[2 * j + 0] = i / items.length;
				uvs[2 * j + 1] = i / items.length;
			}

			let colors = new Uint32Array(colors_u8.buffer);

			// potree.onUpdate( () => {
			// 	potree.renderer.drawMesh({positions, colors, uvs});
			// });

			console.log(`#triangles: ${numVertices / 3}`);

			{
				let geometry = new Geometry();
				geometry.buffers = [
					{name: "position", buffer: positions},
					{name: "uv", buffer: uvs},
					{name: "color", buffer: colors},
				];
				geometry.numElements = numVertices;

				let node = new Mesh("abc", geometry);
				node.material = new PhongMaterial();
				node.material.colorMode = 0;
				scene.root.children.push(node);
			}

			i++;
		}

	}

	// Potree.loadGLB("./resources/models/lion.glb", {
	// // Potree.loadGLB("./resources/models/australia_gas.glb").then(node => {
	// // Potree.loadGLB("./resources/models/australia_gas_30M.glb").then(node => {
	// // Potree.loadGLB("./resources/models/vcity_sitn.glb", {
	// // Potree.loadGLB("./resources/models/anita_mui.glb", {
	// // Potree.loadGLB("./resources/models/anita_mui_aligned.glb").then(node => {
	// // Potree.loadGLB("./resources/models/Big5M.glb", {
	// 	onStart: root => {
	// 		// root.rotation.rotate(1 * Math.PI / 2, new Vector3(0, 1, 0));
	// 		// root.rotation.rotate(1 * Math.PI / 2, new Vector3(0, 1, 0));
	// 		// root.updateWorld();

	// 		// scene.root.children.push(root);

	// 		controls.set({
	// 			position: [-4.3, -5.3, 1.8],
	// 			pivot: [-6.4, 2.6, -0.9],
	// 		});
	// 		// controls.set({
	// 		// 	position: [2390.8, 1143.1, 1010.6],
	// 		// 	pivot: [2383.2, 1445.2, 899.3],
	// 		// });

	// 		console.log("mesh root loaded");
	// 	},
	// 	onNode: node => {
	// 		console.log("subnode loaded");

	// 		node.rotation.rotate(1 * Math.PI / 2, new Vector3(0, 1, 0));
	// 		node.updateWorld();

	// 		scene.root.children.push(node);

	// 		// potree.onUpdate( () => {
	// 		// 	let positions = node.geometry.findBuffer("position");
	// 		// 	let uvs = node.geometry.findBuffer("uv");
	// 		// 	let image = node.material.image;
				
	// 		// 	potree.renderer.drawMesh({positions, uvs, image});
	// 		// });
	// 	},
	// 	onFinish: () => {
	// 		console.log("finished");
	// 	}
	// });

	// {
	// 	let elSlider = document.createElement("input");
	// 	elSlider.type = "range";
	// 	elSlider.style.bottom = "100px";
	// 	elSlider.style.right = "calc(50% - 100px)";
	// 	elSlider.style.width = "200px";
	// 	elSlider.style.position = "absolute";
	// 	elSlider.style.zIndex = "1000";
	// 	elSlider.style.transform = "scale(2, 2)";
	// 	elSlider.min = 0;
	// 	elSlider.max = 200;
	// 	elSlider.value = 200;
	// 	// elSlider.value = 195;

	// 	let onInput = () => {
	// 		let u = elSlider.value / 100;
	// 		Potree.settings.debugU = u * u;
	// 	};

	// 	onInput();

	// 	elSlider.oninput = onInput;

	// 	document.body.appendChild(elSlider);
	// }


</script>

</body>
</html>