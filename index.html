<html>
<head>
<meta http-equiv="origin-trial" content="AmgwKkyLeQetn/dhGSsOlfOa/QLp1JOUgqyYSeFTadHtP83gkgHrDEj62CN//MgSjDbVwOY/LAr4qg/XyU2YYwMAAABdeyJvcmlnaW4iOiJodHRwczovL3BvdHJlZS5vcmc6NDQzIiwiZmVhdHVyZSI6IldlYkdQVSIsImV4cGlyeSI6MTY3NTIwOTU5OSwiaXNTdWJkb21haW4iOnRydWV9">
<style>

td{
	padding: 2px 10px 0px 0px;
}

#big_message{
	position: absolute; 
	left: calc(50%); 
	bottom: 10px; 
	color: white;
	text-shadow: 4px 4px 4px black;
	font-size: 4em;
	font-weight: bold;
	font-family: "Consolas";
	/* from https://stackoverflow.com/a/14249403/913630 */
	text-shadow: 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black;
}

#msg_dbg{
	position: absolute; 
	left: 10px; 
	bottom: 10px; 
	color: white;
	text-shadow: 4px 4px 4px black;
	font-size: 1em;
	font-weight: bold;
	font-family: "Consolas";
	/* from https://stackoverflow.com/a/14249403/913630 */
	text-shadow: 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black;
}

canvas{
	image-rendering: pixelated;
	display: flex;
	position: absolute;
	height: 100%;
}

</style>
</head>
<body style="padding: 0; margin: 0">

<div id="potree" style="width: 100%; height: 100%; position: fixed;">
	<span style="position: relative">
		<canvas id="canvas" width="800" height="600" style="width: 100%; height: 100%;"></canvas>
	</span>
</div>

<span id="big_message"></span>
<span id="msg_dbg"></span>

<script type="importmap">
{
	"imports": {
		"potree":        "./src/Potree.js",
		"lazperf":       "./libs/laz-perf/laz-perf.js",
		"toolbar":       "./src/modules/toolbar/toolbar.js",
		"sidebar":       "./src/modules/sidebar/sidebar.js",
		"dat.gui":       "./libs/dat.gui/dat.gui.module.js",
		"stats":         "./libs/stats.js/stats.module.js",
		"BinaryHeap":    "./libs/BinaryHeap/BinaryHeap.js",
		"tween":         "./libs/tween/tween.esm.js",
		"range-select":  "./libs/range-select/RangeSelect.js",
		"json5":         "./libs/json5/json5.mjs"
	}
}
</script>

<script type="module">

	import {Potree} from "potree";
	import {Vector3, Mesh, Geometry, geometries, Points, PointLight} from "potree";
	import {WireframeMaterial, TriangleColorMaterial} from "potree";
	import {initGUI} from "./src/modules/gui_dat/gui.js";
	import "range-select";
	import {proj4} from "./libs/proj4js/proj4-src.js";
	import {load as loadGLB} from "./src/misc/GLBLoader.js";
	// import {GlbVoxelLoader} from "./src/misc/glbvoxels/GlbVoxelLoader.js";

	console.log(proj4.version);

	// import {installToolbar} from "toolbar";
	import {installSidebar} from "sidebar";

	let canvas = document.getElementById("canvas");
	let elPotree = document.getElementById("potree");
	let potree = await Potree.init(canvas);
	let {scene, controls} = potree;
	// installToolbar(potree.renderer.canvas, potree);

	installSidebar(elPotree, potree).then(sidebar => {
		window.sidebar = sidebar;
		sidebar.toggle();
	});
	// window.sidebar.toggle();

	window.Potree = Potree;
	window.potree = potree;
	window.Vector3 = Vector3;

	// default, if not overriden later on
	// controls.set({
	// 	position: [-19.0, 13.6, 12.2],
	// 	pivot: [-0.0, 2.2, 3.9],
	// });

	import {CopcLoader, Image360, Images360, SplatType} from "potree";
	Potree.settings.edlEnabled = true;
	Potree.settings.dilateEnabled = false;
	Potree.settings.hqsEnabled = true;
	Potree.settings.pointBudget = 4_000_000;
	Potree.settings.attribute = "rgba";
	Potree.settings.pointSize = 5;
	Potree.settings.splatType = SplatType.POINTS;
	Potree.settings.minNodeSize = 200;

	// loadGLB("./resources/models/australia_gas.glb", {
	// 	onStart: (node) => {
	// 		node.rotation.makeIdentity();
	// 		node.rotation.rotate(1.2, {x: 1, y: 0, z: 0});
	// 		node.rotation.rotate(-0.1, {x: 0, y: 1, z: 0});
	// 		node.scale.set(2, 2, 2);
	// 		node.position.set(-25, -10, 10);

	// 		node.name = "australia_gas";

	// 		scene.root.children.push(node);
	// 	}, onNode: (mesh) => {
	// 		console.log(mesh);
	// 	}
	// });

		import {Potree2Loader} from "potree";
	{

		let pc1, pc2;
		// Potree.load("./resources/G/temp/heidentor/").then(pointcloud => {
		// 	scene.root.children.push(pointcloud);
		// 	pointcloud.position.set(0, 0, 0);
		// 	pointcloud.visible = false;

		// 	pc1 = pointcloud;
		// });

		Potree2Loader.load("./resources/G/temp/retz_first/").then(pointcloud => {
			scene.root.children.push(pointcloud);
			pointcloud.position.set(0, 0, 0);
			pointcloud.visible = false;

			pc1 = pointcloud;
		});

		Potree2Loader.load("./resources/G/temp/test/").then(pointcloud => {
			scene.root.children.push(pointcloud);
			pointcloud.position.set(0, 0, 0);

			// debugger;

			let min = new Vector3(...pointcloud.loader.metadata.boundingBox.min);
			let max = new Vector3(...pointcloud.loader.metadata.boundingBox.max);

			let center = max.clone().sub(min).multiplyScalar(0.5);
			let diagonal = max.sub(min);
			let campos = center.clone().add(diagonal);

			// let center = min.clone().add(max).multiplyScalar(0.5);
			// let diagonal = max.sub(min);
			// let campos = center.clone().add(diagonal);


			controls.set({
				position: campos.toArray(), 
				pivot:    center.toArray()
			});
			
			controls.set({
				position: [857.3, 139.6, 210.2], 
				pivot: [681.2, 442.5, -21.4]
			});

			// debugger;

			
			pc2 = pointcloud;
		});

		// controls.set({
		// 	position: [-13.2, 16.8, 13.2], 
		// 	pivot:    [7.5, 7.5, 4.9]
		// });


		
		// controls.set({
		// 	position: [486.4, 386.0, 36.2],
		// 	pivot:    [457.7, 351.1, 3.2],
		// });

		let canvas = potree.renderer.canvas;
		let container = canvas.parentElement;

		let button = document.createElement("input");
		button.value = "toggle (currently showing Potree 2 dataset)";
		button.type = "button";
		button.style.bottom = "10px";
		button.style.left = "10px";
		button.style.position = "absolute";

		button.onclick = () => {
			pc1.visible = pc2.visible;
			pc2.visible = !pc1.visible;

			if(pc1.visible){
				button.value = "toggle (currently showing weighted dataset)";
			}else{
				button.value = "toggle (currently showing random sampled dataset)";
			}
		};
		
		container.append(button);
		
	}

	// {
	// 	Potree.load("./resources/pointclouds/lifeboat/metadata.json").then(pointcloud => {
	// 		scene.root.children.push(pointcloud);
	// 		pointcloud.position.set(0, 10, 0);
	// 	});

	// 	import {Potree2Loader} from "potree";
	// 	Potree2Loader.load("./resources/F/temp/test").then(pointcloud => {
	// 		scene.root.children.push(pointcloud);
	// 		pointcloud.position.set(3, -10, 0);
	// 	});

	// 	controls.set({
	// 		position: [-11.0, 5.4, 13.2], 
	// 		pivot: [9.3, 7.6, 6.2]
	// 	});
	// }

	
	

	// let origin = new Vector3(0, 0, 0);
	// let X = new Vector3(10, 0, 0);
	// let Y = new Vector3(0, 10, 0);
	// let Z = new Vector3(0, 0, 10);
	// let red = new Vector3(255, 0, 0);
	// let green = new Vector3(0, 255, 0);
	// let blue = new Vector3(0, 0, 255);

	// import {sphere} from "./src/modules/geometries/sphere.js";

	// potree.onUpdate( () => {

	// 	// potree.renderer.drawLine(origin, X, red);
	// 	// potree.renderer.drawLine(origin, Y, green);
	// 	// potree.renderer.drawLine(origin, Z, blue);

	// 	// potree.renderer.drawSphere(origin, 2);
	// });



</script>

</body>
</html>