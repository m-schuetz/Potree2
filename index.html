<html>
<head>
<style>

td{
	padding: 2px 10px 0px 0px;
}

#big_message{
	position: absolute; 
	left: calc(50%); 
	bottom: 10px; 
	color: white;
	text-shadow: 4px 4px 4px black;
	font-size: 4em;
	font-weight: bold;
	font-family: "Consolas";
	/* from https://stackoverflow.com/a/14249403/913630 */
	text-shadow: 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black;
}

#msg_dbg{
	position: absolute; 
	left: 10px; 
	bottom: 10px; 
	color: white;
	text-shadow: 4px 4px 4px black;
	font-size: 1em;
	font-weight: bold;
	font-family: "Consolas";
	/* from https://stackoverflow.com/a/14249403/913630 */
	text-shadow: 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black, 0 0 4px black;
}

canvas{
	image-rendering: pixelated;
}

</style>
</head>
<body style="padding: 0; margin: 0">


<canvas id="canvas" width="800" height="600" 
	style="
		width: 100%; height: 100%;
		grid-column: 1; grid-row: 1">
</canvas>

<!-- <span style="position: absolute; left: 10px; top: 70px; 
	background-color: white; opacity: 0.7; padding: 10px;">
	
	<span style="font-weight: bold">Rewriting Potree in WebGPU:</span>

	<ul>
		<li>Highly experimental and crashy.</li>
		<li>Requires <a href="https://www.google.com/intl/de/chrome/canary/">Chrome Canary 92</a></li>
		<li>To enable WebGPU, open this URL: <pre>chrome://flags/#enable-unsafe-webgpu</pre></li>
		<li>Github: <a href="https://github.com/m-schuetz/Potree2">https://github.com/m-schuetz/Potree2</a></li>
	</ul>

</span> -->

<span id="big_message"></span>
<span id="msg_dbg"></span>

<script type="importmap">
{
	"imports": {
		"potree":      "./src/Potree.js",
		"toolbar":     "./src/modules/toolbar/toolbar.js",
		"dat.gui":     "./libs/dat.gui/dat.gui.module.js",
		"glslang":     "./libs/glslang/glslang.js",
		"stats":       "./libs/stats.js/stats.module.js",
		"BinaryHeap":  "./libs/BinaryHeap/BinaryHeap.js"
	}
}
</script>

<script type="module">

	import {Potree} from "potree";
	import {Vector3, Mesh, Geometry, Quads, geometries, Points, PointLight} from "potree";
	import {WireframeMaterial, TriangleColorMaterial} from "potree";
	import {initGUI} from "./src/modules/gui_dat/gui.js";
	// import {initGUI} from "./src/modules/gui_dat/gui_compute_demo.js";
	import {simplify} from "./src/prototyping/simplify.js"
	import {generateLOD} from "./src/prototyping/generate_lod.js"
	import {generateVoxels} from "./src/prototyping/generate_voxels.js"
	import {generateVoxelsGpu} from "./src/prototyping/generate_voxels_gpu.js"
	import {generateVoxelsCompute } from "./src/prototyping/generate_voxels_compute/generate_voxels_compute.js"

	import {installToolbar} from "toolbar";

	let canvas = document.getElementById("canvas");
	let potree = await Potree.init(canvas);
	let {scene, controls} = potree;
	installToolbar(potree.renderer.canvas, potree);

	window.Potree = Potree;
	window.potree = potree;
	window.Vector3 = Vector3;

	initGUI(potree);
	guiContent["point budget (M)"] = 2;
	guiContent["point size"] = 5;
	guiContent["High-Quality"] = false;
	guiContent["Eye-Dome-Lighting"] = false;
	guiContent["dilate"] = false;
	// guiContent["attribute"] = "intensity";




	// default, if not overriden later on
	controls.set({
		yaw: -0.2,
		pitch: 0.8,
		radius: 10,
	});

	// let url = "./resources/pointclouds/lion/metadata.json";
	// Potree.load(url, {name: "Lion"}).then(pointcloud => {
	// 	scene.root.children.push(pointcloud);

	// 	controls.set({
	// 		position: [6.3, -4.0, 7.6],
	// 		pivot: [0.6, -0.2, 4.5],
	// 	});
	// });

	// {
	// 	let geometry = geometries.createPointsData(6000);
	// 	// let geometry = geometries.createPointsSphere(50_000_000);
	// 	let points = new Points("points", geometry.geometry);

	// 	scene.root.children.push(points);
	// 	camera.fov = 60;
	// }

	// let url = "./resources/pointclouds/heidentor/metadata.json";
	// Potree.load(url, {name: "Heidentor"}).then(pointcloud => {
	// 	scene.root.children.push(pointcloud);

	// 	controls.set({
	// 		radius: 26.8, yaw: -4.2, pitch: 0.31,
	// 		pivot: [-0.182792265881022, 1.9724050351418307, 5.693598313985278],
	// 	});

	// 	// controls.set({
	// 	// 	position: [-16.8, 12.0, 10.8],
	// 	// 	pivot: [-1.7482506615697777, 4.1140199696259545, 7.4239815576054085],
	// 	// });

	// });

	// Potree.load("./resources/pointclouds/ca13/metadata.json", {name: "CA13"}).then(pointcloud => {
	// 	scene.root.children.push(pointcloud);
		
	// 	// controls.set({
	// 	// 	position: [694333.496789461, 3915147.2756878096, 1088.4989729879585],
	// 	// 	pivot: [695211.9299879028, 3916448.5033958578, 95.82708962004546],
	// 	// });

	// 	controls.set({
	// 		position: [694623.2216978263, 3916163.3819058607, 141.51053932619533],
	// 		pivot: [694689.0157219684, 3916447.440557414, 56.51987395905676],
	// 	});

	// });




	// Potree.load("./resources/pointclouds/octree_cuda/metadata.json", {name: "CA13"}).then(pointcloud => {
	// // Potree.load("https://potree.org/pointclouds/CA13/metadata.json", {name: "CA13"}).then(pointcloud => {
	// 	scene.root.children.push(pointcloud);
		
	// 	controls.set({
	// 		position: [-2.8768227778537447, 14.02743299889709, 12.167932888490938],
	// 		pivot: [8.814317925142443, 7.502405843847264, 4.8142897145105827],
	// 	});

	// });

	// Potree.load("./resources/pointclouds/heidentor/metadata.json", {name: "CA13"}).then(pointcloud => {
	// 	scene.root.children.push(pointcloud);

	// 	pointcloud.position.set(3.504, 0, 0.72)
	// 	pointcloud.visible = false;
		
	// 	// controls.set({
	// 	// 	position: [-2.8768227778537447, 14.02743299889709, 12.167932888490938],
	// 	// 	pivot: [8.814317925142443, 7.502405843847264, 4.8142897145105827],
	// 	// });

	// 	// let state = scene.root.children[2].visible;
	// 	// scene.root.children[2].visible = !state;
	// 	// scene.root.children[3].visible = state;
		

	// });

	// {
	// 	function toggleVisibility(){
	// 		let state = scene.root.children[2].visible;
	// 		scene.root.children[2].visible = !state;
	// 		scene.root.children[3].visible = state;
	// 	}

	// 	let elToggle = document.createElement("input");
	// 	elToggle.type = "button";
	// 	elToggle.value = "toggle";
	// 	elToggle.style.position = "absolute";
	// 	elToggle.style.zIndex = 1000;
	// 	elToggle.style.left = "500px";
	// 	elToggle.style.bottom = "10px";

	// 	elToggle.addEventListener("click", () => {
	// 		toggleVisibility();
	// 	});


	// 	document.body.appendChild(elToggle);

	// }




	// Potree.load("./resources/pointclouds/ot_35120C7102A_1/metadata.json", {name: "CA13"}).then(pointcloud => {
	// 	scene.root.children.push(pointcloud);

	// 	controls.set({
	// 		pivot: [694653.9801853563, 3916378.995565914, 19.012428318784117],
	// 		position: [694268.0217624231, 3916089.355137903, 238.7199595303422],
	// 	});
	// });

	// Potree.loadGLB("./resources/models/lion.glb").then(node => {
	// Potree.loadGLB("./resources/models/australia_gas.glb").then(node => {
	// Potree.loadGLB("./resources/models/australia_gas_30M.glb").then(node => {
	// Potree.loadGLB("./resources/models/sitnmesh.glb").then(node => {
	// Potree.loadGLB("./resources/models/lausanne_wood_thing.glb").then(node => {
	Potree.loadGLB("./resources/models/anita_mui.glb").then(node => {
	// Potree.loadGLB("./resources/models/anita_mui_aligned.glb").then(node => {

		// node.set({
		// 	position: [5, 0, 3],
		// 	scale: [4, 4, 4],
		// });
		node.rotation.rotate(1 * Math.PI / 2, new Vector3(0, 1, 0));

		// node.set({
		// 	position: [-15, -15, 4],
		// 	scale: [4, 4, 4],
		// });
		// node.rotation.rotate(0.9 * Math.PI / 2, new Vector3(1, 0, 0));

		// node.material = new WireframeMaterial();
		// scene.root.children.push(node);
		window.node = node;


		let light = new PointLight();
		light.position.set(10, 10, 10);

		scene.root.children.push(light);


		{ // add wireframe
			let node2 = new Mesh("wireframe", node.geometry);

			// node2.material = new TriangleColorMaterial();
			node2.material = new WireframeMaterial();
			node2.material.color.set(0, 0.5, 0);
			node2.position.copy(node.position);
			node2.scale.copy(node.scale);
			node2.rotation.copy(node.rotation);

			// scene.root.children.push(node2);
		}

		node.updateWorld();
		// simplify(node);
		// generateLOD(node);
		// generateVoxels(node);
		// generateVoxelsGpu(potree.renderer, node);
		generateVoxelsCompute(potree.renderer, node);

		controls.set({
			position: [-3.4, -4.3, -8.9],
			pivot: [-0.4, -0.9, -5.9],
		});
		controls.set({
			position: [-5.3, -5.9, -4.2],
			pivot: [0.4, 0.4, -6.3],
		});

	});

	// {
	// 	let lines = [];
	// 	for(let i = 0; i < 10; i++){

	// 		let start = new Vector3(
	// 			20 * Math.random() - 10, 
	// 			20 * Math.random() - 10, 
	// 			20 * Math.random() - 10);
	// 		let end = new Vector3(
	// 			20 * Math.random() - 10, 
	// 			20 * Math.random() - 10, 
	// 			20 * Math.random() - 10);
	// 		let color = new Vector3(0, 255, 0);
	// 		lines.push([start, end, color]);

	// 	}

	// 	potree.onUpdate( () => {
	// 		for(let line of lines){
	// 			potree.renderer.drawLine(...line);
	// 		}
	// 	});
	// }
	

	// Potree.loadGLB("./resources/models/australia_gas.glb").then(node => {
	// // Potree.loadGLB("./resources/models/anita_mui.glb").then(node => {

	// 	// node.set({
	// 	// 	position: [5, 0, 3],
	// 	// 	scale: [4, 4, 4],
	// 	// });
	// 	// node.rotation.rotate(0.9 * Math.PI / 2, new Vector3(0, 1, 0));

	// 	node.set({
	// 		position: [-15, -15, 4],
	// 		scale: [4, 4, 4],
	// 	});
	// 	node.rotation.rotate(0.9 * Math.PI / 2, new Vector3(1, 0, 0));

	// 	// scene.root.children.push(node);


	// 	let light = new PointLight();
	// 	light.position.set(10, 10, 10);

	// 	scene.root.children.push(light);


	// 	// { // add wireframe
	// 	// 	let node2 = new Mesh("wireframe", node.geometry);

	// 	// 	// node2.material = new TriangleColorMaterial();
	// 	// 	node2.material = new WireframeMaterial();
	// 	// 	node2.material.color.set(0, 1, 0);
	// 	// 	node2.position.copy(node.position);
	// 	// 	node2.scale.copy(node.scale);
	// 	// 	node2.rotation.copy(node.rotation);

	// 	// 	// scene.root.children.push(node2);
	// 	// }

	// 	node.updateWorld();
	// 	simplify(node);

	// 	controls.set({
	// 		position: [-7.8, 4.6, 2.9],
	// 		pivot: [-11, -5.2, -0.7],
	// 	});

	// });

	// {
	// 	let numTriangles = 10_000;
	// 	let positions = new Float32Array(3 * numTriangles);
	// 	let colors = new Uint8Array(3 * 4 * numTriangles);

	// 	for(let i = 0; i < numTriangles; i++){
	// 		positions[3 * i + 0] = Math.random() * 10 - 5;
	// 		positions[3 * i + 1] = Math.random() * 10 - 5;
	// 		positions[3 * i + 2] = Math.random() * 10 - 5;

	// 		colors[4 * i + 0] = Math.random() * 255;
	// 		colors[4 * i + 1] = Math.random() * 255;
	// 		colors[4 * i + 2] = Math.random() * 255;
	// 		colors[4 * i + 3] = 255;
	// 	}

	// 	potree.onUpdate( () => {
	// 		potree.renderer.drawMesh({positions, colors});
	// 	});
	// }

	// potree.addEventListener("update", (e) => {
	// 	// potree.renderer.drawLine([0, 0, 0], [10, 10, 10], [255, 0, 0]);
	// });

	// controls.set({
	// 	position: [15, 11, 10],
	// 	pivot: [0, 0, 0],
	// });
	

	// {
	// 	let n = 1_000;
	// 	let positions = new Float32Array(3 * n);

	// 	for(let i = 0; i < n; i++){
	// 		positions[3 * i + 0] = Math.random() * 100 - 50;
	// 		positions[3 * i + 1] = Math.random() * 100 - 50;
	// 		positions[3 * i + 2] = Math.random() * 2 + 5;
	// 	}

	// 	fetch("./resources/images/360.png").then( async (response) => {
	// 	// fetch("./resources/images/background.jpg").then( async (response) => {
	// 		let quads = new Quads("quads", positions);
	// 		let buffer = await response.arrayBuffer();
	// 		let u8 = new Uint8Array(buffer);

	// 		let blob = new Blob([u8], {type: "image/png"});
	// 		let image = await createImageBitmap(blob);
	// 		let texture = renderer.getGpuTexture(image);

	// 		quads.texture = texture;
	// 		scene.root.children.push(quads);
	// 	});
		


		
	// }

</script>

</body>
</html>